
dist: xenial
language: python
sudo: false

cache:
  directories:
  - "$HOME/.cache/pip"

os:
  - linux

python:
  - 'pypy'
  - 'pypy3'
  - '3.5'
  - '3.7'

install:
  - travis_retry pip install codecov
  - travis_retry pip install -r requirements.txt
  - travis_retry pip install -e .

script:
  - pytest --cov=clkhash
  - codecov -e TRAVIS_OS_NAME,TRAVIS_PYTHON_VERSION,INCLUDE_CLI -n $COV_NAME


jobs:
  allow_failures:
    - python: 'nightly'
    - python: '3.8-dev'

  include:
    - stage: Test
      python: 'nightly'
      env:
        - COV_NAME=linux_nightly
    - python: '3.8-dev'
      env:
        - INCLUDE_CLI=1
        - COV_NAME=linux_3.8-dev_CLI
    - python: '3.6'
      env:
        - INCLUDE_CLI=1
        - COV_NAME=linux_3.6_CLI
    - python: '2.7'
      env:
        - INCLUDE_CLI=1
        - COV_NAME=linux_2.7_CLI
    # OSX + Python is officially supported by Travis CI as of April 2011
    # https://docs.travis-ci.com/user/reference/osx/
    - os: osx
      osx_image: xcode8.3
      python: "3.6-dev"
      env:
        - COV_NAME=osx_3.6

    - stage: Integration
      name: Test Notebooks
      python: 3.7
      before_install:
        - travis_retry pip install -U -r docs/doc-requirements-anonlink.txt -r docs/doc-requirements-others.txt
      script:
        - pytest --nbval docs -x --sanitize-with docs/tutorial_sanitize.cfg

    - stage: Integration
      python: '3.8-dev'
      env:
        - TEST_ENTITY_SERVICE=https://testing.es.data61.xyz
        - INCLUDE_CLI=1
        - COV_NAME=linux_3.8-dev_CLI_ES
    - stage: Integration
      python: '3.7'
      env:
        - TEST_ENTITY_SERVICE=https://testing.es.data61.xyz
        - INCLUDE_CLI=1
        - COV_NAME=linux_3.7_CLI_ES
    - stage: Integration
      python: '2.7'
      env:
        - TEST_ENTITY_SERVICE=https://testing.es.data61.xyz
        - INCLUDE_CLI=1
        - COV_NAME=linux_2.7_CLI_ES

